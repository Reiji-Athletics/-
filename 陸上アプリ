import streamlit as st
import random
import pandas as pd
from datetime import date
import matplotlib.pyplot as plt

st.set_page_config(page_title="RunMate+", page_icon="ğŸƒ")

# åŠ±ã¾ã—ã®è¨€è‘‰
words = [
    "åŠªåŠ›ã‚’ã—ã¦ã„ã‚‹äººé–“ã‚’ç¬‘ã†ãªã€‚å¤¢ã‚’èªã‚‹äººé–“ã‚’ç¬‘ã†ãªã€‚",
    "è«¦ã‚ãªã‘ã‚Œã°å¤±æ•—ã˜ã‚ƒãªã„ã€‚ç¶™ç¶šã§ãã‚‹ã“ã¨ã‚‚æ‰èƒ½ã®ä¸€ã¤ã ã€‚",
    "ãŠå‰ãŒã‚µãƒœã£ã¦ã„ã‚‹é–“ã«ã€èª°ã‹ãŒåŠªåŠ›ã—ã¦ã„ã‚‹ã€‚",
    "æ˜¨æ—¥ã®è‡ªåˆ†ã‚’è¶…ãˆã‚‹ã“ã¨ã€ãã‚ŒãŒæœ¬å½“ã®æˆé•·ã ã€‚",
    "æ‰èƒ½ãŒãªãã¦ã‚‚ã€ç¶™ç¶šã¯èª°ã«ã§ã‚‚ã§ãã‚‹æœ€å¼·ã®æ­¦å™¨ã ã€‚"
]

# åˆæœŸåŒ–
if "records" not in st.session_state:
    st.session_state["records"] = []
if "comments" not in st.session_state:
    st.session_state["comments"] = []

st.title("ğŸƒ RunMate+ - ä¸­å­¦ç”Ÿå‘ã‘100mèµ°è¨˜éŒ²ã‚¢ãƒ—ãƒª")

with st.form("run_form"):
    name = st.text_input("é¸æ‰‹å")
    inseam = st.number_input("è‚¡ä¸‹ã®é•·ã•ï¼ˆcmï¼‰", step=1)
    time_sec = st.number_input("ä»Šå›ã®ã‚¿ã‚¤ãƒ ï¼ˆç§’ï¼‰", step=0.1, format="%.2f")
    steps = st.number_input("ä»Šå›ã®æ­©æ•°", step=1)
    weather = st.selectbox("å¤©æ°—", ["æ™´ã‚Œ", "æ›‡ã‚Š", "é›¨"])
    start_conf = st.selectbox("ã‚¹ã‚¿ãƒ¼ãƒˆã®è‡ªä¿¡", ["â—¯", "â–³", "âœ•"])
    finish_tired = st.selectbox("ãƒ•ã‚£ãƒ‹ãƒƒã‚·ãƒ¥ã§ç–²ã‚ŒãŸã‹", ["â—¯", "â–³", "âœ•"])
    submitted = st.form_submit_button("è¨˜éŒ²ï¼†åˆ†æ")

if submitted and name and inseam and steps:
    step_length = 100 / steps
    ideal_step_length = inseam / 100 * 1.14
    ideal_steps = 100 / ideal_step_length

    advice = []
    training = []

    # æ­©å¹…ã«é–¢ã™ã‚‹ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã¨ç·´ç¿’
    if step_length < ideal_step_length - 0.1:
        advice.append("æ­©å¹…ãŒç†æƒ³ã‚ˆã‚Šå°ã•ã„ã‚ˆã†ã§ã™ã€‚åœ°é¢ã‚’å¼·ãè¹´ã‚‹æ„è­˜ã‚’æŒã¡ã¾ã—ã‚‡ã†ã€‚")
        training.append("å‚é“ãƒ€ãƒƒã‚·ãƒ¥ã‚„ãƒ©ãƒ€ãƒ¼ã‚’ä½¿ã£ãŸçˆ†ç™ºçš„ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°")
    elif step_length > ideal_step_length + 0.1:
        advice.append("æ­©å¹…ãŒç†æƒ³ã‚ˆã‚Šå¤§ãã™ãã¾ã™ã€‚ãƒ”ãƒƒãƒèµ°æ³•ã‚’æ„è­˜ã—ã¾ã—ã‚‡ã†ã€‚")
        training.append("çŸ­ã„è·é›¢ã‚’é«˜é »åº¦ã§èµ°ã‚‹ãƒ‰ãƒªãƒ«ï¼ˆãƒ”ãƒƒãƒå¼·åŒ–ï¼‰")
    else:
        advice.append("æ­©å¹…ã¯ç†æƒ³çš„ã§ã™ã€‚ã“ã®èª¿å­ã§ãƒ”ãƒƒãƒã‚„ã‚¹ã‚¿ãƒ¼ãƒˆã‚‚æ„è­˜ã—ã¾ã—ã‚‡ã†ã€‚")

    # ã‚¹ã‚¿ãƒ¼ãƒˆ
    if start_conf == "âœ•":
        advice.append("ã‚¹ã‚¿ãƒ¼ãƒˆã®å§¿å‹¢ã‚’æ”¹å–„ã—ã¾ã—ã‚‡ã†ã€‚")
        training.append("ã‚¯ãƒ©ã‚¦ãƒãƒ³ã‚°ã‚¹ã‚¿ãƒ¼ãƒˆç·´ç¿’ã€ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ç·´ç¿’")
    elif start_conf == "â–³":
        advice.append("ã‚¹ã‚¿ãƒ¼ãƒˆã«å°‘ã—ä¸å®‰ãŒã‚ã‚‹ã‚ˆã†ã§ã™ã€‚")
        training.append("ã‚¹ã‚¿ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã‚¹ã‚¿ãƒ¼ãƒˆã‚„åå¿œç·´ç¿’")

    # ãƒ•ã‚£ãƒ‹ãƒƒã‚·ãƒ¥
    if finish_tired == "â—¯":
        advice.append("çµ‚ç›¤ã«ãƒãƒ†ã‚‹ãªã‚‰ã€æŒä¹…åŠ›ã®å‘ä¸Šã‚’ç›®æŒ‡ã—ã¾ã—ã‚‡ã†ã€‚")
        training.append("100m Ã— 3æœ¬ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ã€200mãƒ†ãƒ³ãƒèµ°")

    # çµæœä¿å­˜
    result = {
        "æ—¥ä»˜": date.today().isoformat(),
        "é¸æ‰‹å": name,
        "ã‚¿ã‚¤ãƒ ": time_sec,
        "æ­©æ•°": steps,
        "æ­©å¹…": round(step_length, 2),
        "ç†æƒ³æ­©å¹…": round(ideal_step_length, 2),
        "ç†æƒ³æ­©æ•°": int(ideal_steps),
    }
    st.session_state["records"].append(result)

    st.header("ğŸ“Š çµæœ")
    st.write(result)

    st.subheader("ğŸ§  ã‚¢ãƒ‰ãƒã‚¤ã‚¹")
    for a in advice:
        st.markdown(f"- {a}")

    st.subheader("ğŸ’ª ç·´ç¿’ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ææ¡ˆ")
    unique_training = list(set(training))  # é‡è¤‡ã‚’æ’é™¤
    for t in unique_training:
        st.markdown(f"- {t}")

    st.subheader("ğŸ’¬ åŠ±ã¾ã—ã®è¨€è‘‰")
    st.success(random.choice(words))

# è¨˜éŒ²ä¸€è¦§
st.subheader("ğŸ“‹ é¸æ‰‹ã”ã¨ã®è¨˜éŒ²ä¸€è¦§")
df = pd.DataFrame(st.session_state["records"])
st.dataframe(df)

# æŠ˜ã‚Œç·šã‚°ãƒ©ãƒ•
st.subheader("ğŸ“ˆ ã‚¿ã‚¤ãƒ ã®æ¨ç§»ã‚°ãƒ©ãƒ•")
if not df.empty:
    selected_player = st.selectbox("é¸æ‰‹ã‚’é¸ã¶", df["é¸æ‰‹å"].unique())
    player_df = df[df["é¸æ‰‹å"] == selected_player]
    fig, ax = plt.subplots()
    ax.plot(player_df["æ—¥ä»˜"], player_df["ã‚¿ã‚¤ãƒ "], marker="o")
    ax.set_title(f"{selected_player} ã®ã‚¿ã‚¤ãƒ æ¨ç§»")
    ax.set_xlabel("æ—¥ä»˜")
    ax.set_ylabel("ã‚¿ã‚¤ãƒ ï¼ˆç§’ï¼‰")
    st.pyplot(fig)

# åå‰ä»˜ãã‚³ãƒ¡ãƒ³ãƒˆ
st.subheader("ğŸ’¬ å¿œæ´ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆåå‰ä»˜ãï¼‰")
col1, col2 = st.columns(2)
with col1:
    commenter_name = st.text_input("ã‚ãªãŸã®åå‰", key="commenter_name")
with col2:
    comment_text = st.text_input("å¿œæ´ã‚³ãƒ¡ãƒ³ãƒˆ", key="comment_text")

if st.button("ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ "):
    if commenter_name and comment_text:
        st.session_state["comments"].append(f"{commenter_name}ï¼š{comment_text}")
        st.success("ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ã—ã¾ã—ãŸï¼")
    else:
        st.warning("åå‰ã¨ã‚³ãƒ¡ãƒ³ãƒˆä¸¡æ–¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚")

if st.session_state["comments"]:
    for c in st.session_state["comments"]:
        st.markdown(f"- {c}")
